<!DOCTYPE html>
<html>
<head> <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="auth.js"></script>
  <script>
    try {
      checkAccess();
    } catch (error) {
      console.error("Erreur lors de la vÃ©rification d'accÃ¨s :", error);
    }
  </script>
  <link rel="icon" type="image/png" href="TOTEM1.png">
  <title>Urgence 2025</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfGs1gnWhKjQvgeebgoMtptzwjMwBKwh0&libraries=places,marker&callback=initMap" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: white;
        }
        .header {
            position: relative;
            width: 100%;
            height: 300px;
            background: url('marty.png') no-repeat center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: black;
            padding: 20px;
        }
        .header h1 {
            font-size: 47px;
            font-weight: bold;
        }
        .header p {
            font-size: 20px;
            font-weight: bold;
            max-width: 600px;
            margin-top: 10px;
        }
        .phone {
            font-size: 32px;
            font-weight: bold;
            margin-top: 20px;
        }
    #map { height: 410px; width: 100%; }
    #error-message { color: red; }
    #debug-info { margin-top: 10px; white-space: pre-wrap; font-family: Arial, sans-serif; }
    /* Style de la lÃ©gende */
    #legend {
      margin-top: 10px;
      padding: 5px;
      border: 1px solid black;
      width: fit-content;
      background-color: rgb(255, 255, 255);
      font-family: Arial, sans-serif;
    }
    #legend ul { list-style: none; padding: 0; margin: 0; }
    #legend li { margin-bottom: 4px; }
    /* Style de la barre de recherche */
    #search-container {
      margin: 10px 0;
      font-family: Arial, sans-serif;
    }
    #search-input {
      padding: 5px;
      width: 250px;
      font-size: 14px;
    }
    #search-button {
      padding: 5px 10px;
      font-size: 14px;
    }
    /* Style pour la ligne en surbrillance dans le debug */
    .highlight {
      background-color: yellow;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Urgence 2025</h1>
    <p>
        MalgrÃ© la neige, et le vent â€¦ et la pluie, MalgrÃ© les rafales et les intempÃ©ries,<br>
        Et la grÃªle, et les tourbillons, Par-dessus les plaines et les monts,<br>
        DÃ©fiant les tornades et les Ã©clairs, AlizÃ©, aquilon et tonnerre,<br>
        Le rapatrieur dÃ©vouÃ© vole livrer Ã  chacun son bÃ©bÃ©,<br>
        Rien ne saurait lâ€™arrÃªter !<br><br>
        <strong>DUMBO</strong>
    </p>
    <p class="phone">0483650279</p>
</div>

  <div id="map"></div>
  <!-- Barre de recherche -->
  <div id="search-container">
    <button id="switchMapButton">Afficher/Enlever la carte bÃ©nÃ©voles</button>
  <button id="switchMapButton2">Afficher/Enlever la carte Relai</button>
  <input type="text" id="search-input" placeholder="Rechercher une commune ou un marqueur" />
    <button id="search-button">Rechercher</button>
    <button id="switchMapButtonUrgence">carte Urgence (Ajouter/Enlever tous les bÃ©nÃ©voles )</button>

   
  
  <div id="legend">
      <strong>LÃ©gende :</strong>
      <ul id="legend-list"></ul>
  </div>
  <div id="error-message"></div>
  <div id="debug-info"></div>
  <div id="debug-info"></div>
<iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdYmy3eCjHTysUDNlxZLb3flDGO8rR5OBlYthfuRYx3zOSZNA/viewform?embedded=true" width="640" height="800" frameborder="0" marginheight="0" marginwidth="0">Chargementâ€¦</iframe>
<iframe src="https://docs.google.com/spreadsheets/d/1WJ5bBVULuvcCbTtekb4jAbY58cHOA0YmbLiuPDiQZ64/edit"
        width="600" height="800"></iframe>
<iframe src="https://docs.google.com/spreadsheets/d/1PSjpRvCEZI1pqhebKzsGvdVUrOHlzc1d/edit" 
        width="600" height="800"></iframe>
<iframe src="https://docs.google.com/spreadsheets/d/1SjBmjncMrk6WSFh-0KUzp8Rr55EZqYpcsL2PetWwskU/edit" 
        width="600" height="800"></iframe>

        <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1-tf56PIvRYV-y_Zvg2n36OfwC4Sv-MY&femb=1&ll=43.4647048189242%2C6.29414399999999&z=9" width="800" height="800"></iframe>

        <iframe src="https://drive.google.com/file/d/1O53vgIu8fT0flb4bh12cCP7a_gxP2fxq/preview" 
                  width="800" height="800"></iframe>
      </div>

  
  <script>
    let map;
    let markers = [];
    const GEOCODING_CACHE_KEY = 'geocodingCache';
    const GEOCODING_DELAY = 5; // dÃ©lai en ms
    let infoWindow;
    // Variables pour la recherche
    let searchResults = [];
    let currentSearchIndex = 0;
    let lastSearchTerm = "";
    let urgentMode = false;


    async function geocodeWithCache(geocoder, cityName) {
      let cache = JSON.parse(localStorage.getItem(GEOCODING_CACHE_KEY) || '{}');
      if (cache[cityName]) {
        console.log(`Utilisation du cache pour ${cityName}`);
        return cache[cityName];
      }
      await new Promise(resolve => setTimeout(resolve, GEOCODING_DELAY));
      return new Promise((resolve, reject) => {
        geocoder.geocode({ address: cityName + ', France' }, (results, status) => {
          if (status === 'OK') {
            const location = results[0].geometry.location;
            cache[cityName] = { lat: location.lat(), lng: location.lng() };
            localStorage.setItem(GEOCODING_CACHE_KEY, JSON.stringify(cache));
            console.log(`GÃ©ocodage rÃ©ussi pour ${cityName}`);
            resolve({ lat: location.lat(), lng: location.lng() });
          } else {
            console.error(`Erreur de gÃ©ocodage pour ${cityName}: ${status}`);
            reject(status);
          }
        });
      });
    }

    // Fonctions de crÃ©ation des icÃ´nes SVG
    function createPhoneSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ“</text></svg>`;
    }
    function createAmbulanceSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸš‘</text></svg>`;
    }
    function createCrossSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ©º</text></svg>`;
    }
    function createMammSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¦Š</text></svg>`;
    }
    function createOisSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¦†</text></svg>`;
    }
    function createChiroSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¦‡</text></svg>`;
    }
    function createDomSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¶</text></svg>`;
    }
    function createreptSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¦</text></svg>`;
    }
    function createtortSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¢</text></svg>`;
    }
    function createserpSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ</text></svg>`;
    }
    function createamphiSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><text x="5" y="30" font-size="30" fill="${color}">ğŸ¸</text></svg>`;
    }
    // Fonction par dÃ©faut pour les autres cas
    function createTriangleSVG(color) {
      return `data:image/svg+xml;charset=UTF-8,<svg width="20" height="20" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><polygon points="15,5 25,25 5,25" fill="${color}" stroke="black" stroke-width="2" /></svg>`;
    }

    const csvURL1 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgn7Ua3wOiYoVnr2Tl-dSiBucRC_w0mUEJdMmdmeySAEiEBkBGyLmjuXcCSkR_AYzt_r92du7FfWHk/pub?gid=527237974&single=true&output=csv';
    const csvURL2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsfjj7eltK_SoO5hXkwQeZIp-Cufzc1DrcMUOyhrRnvgPi6w4cJB3fVCptVpiQG7RwB6EmsnqhZhQF/pub?gid=0&single=true&output=csv';
    const csvURL3 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJbceq23ZJu_g-hTTFpIEEQbypFTT_dCABIIUcLcrUo9rilU0MmRG-NGFUCEJ_dw/pub?gid=1056850233&single=true&output=csv';

    let currentCSV = csvURL1;

    function switchMap() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      currentCSV = (currentCSV === csvURL1) ? csvURL2 : csvURL1;
      updateData(currentCSV);
    }
    function switchMapToCSV3() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      currentCSV = (currentCSV !== csvURL3) ? csvURL3 : csvURL1;
      updateData(currentCSV);
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("switchMapButton").addEventListener("click", switchMap);
      document.getElementById("switchMapButton2").addEventListener("click", switchMapToCSV3);
      document.getElementById("switchMapButtonUrgence").addEventListener("click", switchMapUrgence);
      document.getElementById("search-button").addEventListener("click", searchMarkers);
    });
    function switchMapUrgence() {
  // Si le mode urgence est dÃ©jÃ  activÃ©, on le dÃ©sactive et on revient Ã  la carte CSV1
  urgentMode = !urgentMode;
  markers.forEach(marker => marker.setMap(null));
  markers = [];
  // Pour le mode urgence, on charge toujours le CSV2, mais en ignorant le statut
  currentCSV = csvURL2;
  updateData(currentCSV);
}


    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 8.8,
        center: {lat: 43.453354, lng: 6.288334}
      });
      infoWindow = new google.maps.InfoWindow();
      updateData(currentCSV);
      setInterval(() => updateData(currentCSV), 120000);
    }

    function calculateCirclePoints(center, maxPoints, radius) {
      const points = [];
      for (let i = 0; i < maxPoints; i++) {
        const angle = (2 * Math.PI * i) / maxPoints;
        const lat = center.lat() + (radius / 111111) * Math.cos(angle);
        const lng = center.lng() + (radius / (111111 * Math.cos(center.lat() * Math.PI / 180))) * Math.sin(angle);
        points.push(new google.maps.LatLng(lat, lng));
      }
      return points;
    }

    function extractData(row, csvUrl) {
      if (csvUrl === csvURL1) {
        return {
          name: row[9]?.trim() || '',
          repondu: row[1]?.trim() || '',
          Numero: row[2]?.trim() || '',
          cityName: row[3]?.trim() || '',
          espece: row[4]?.trim() || '',
          address: (row[12]?.trim() && row[12].trim() !== "") ? row[12].trim() : row[3]?.trim() || '',
          status: row[13]?.trim() || '',
          seil: row[0]?.trim() || '',
          Esp: row[14]?.trim() || '',
          info: (row[12]?.trim() && row[12].trim() !== "") ? row[12].trim() : row[3]?.trim() || '',
          Emoj: row[16]?.trim() || '',
          Emoj2: row[11]?.trim() || ''
        };
      } else if (csvUrl === csvURL2) {
        return {
          name: row[0]?.trim() || '',
          status: row[1]?.trim() || '',
          cityName: row[2]?.trim() || '',
          espece: row[3]?.trim() || '',
          Numero: row[4]?.trim() || '',
          address: (row[2]?.trim() && row[2].trim() !== "") ? row[2].trim() : '',
          repondu: row[1]?.trim() || '',
          jourdispo: row[6]?.trim() || '',
          marqueur: row[3]?.trim() || '',
          Emoj: row[7]?.trim() || '',
          info: row[5]?.trim() || '' 
        };
      } else if (csvUrl === csvURL3) {
        return {
          name: row[0]?.trim() || '',
          status: row[8]?.trim() || '',
          cityName: row[2]?.trim() || '',
          espece: row[1]?.trim() || '',
          Numero: row[3]?.trim() || '',
          address: (row[2]?.trim() && row[2].trim() !== "") ? row[2].trim() : '',
          repondu: row[1]?.trim() || '',
          info: row[5]?.trim() || '',
          marqueur: row[7]?.trim() || '',
          Emoj: row[12]?.trim() || '',
          Emoj2: row[13]?.trim() || '',
          jourdispo: row[14]?.trim() || ''
        
        };
      }
      return {};
    }

    function updateLegend(csvUrl) {
      const legend = document.getElementById("legend");
      const legendList = document.getElementById("legend-list");
      if (csvUrl === csvURL1) {
        legend.style.display = 'inline';
        legendList.innerHTML = `
          <span style="font-size:20px;">ğŸ¦†</span> : Oiseaux
          <span style="font-size:20px;">ğŸ¦Š</span> : MammifÃ¨res
          <span style="font-size:20px;">ğŸ¦‡</span> : ChiroptÃ¨res
          <span style="font-size:20px;">ğŸ</span> : Serpents
          <span style="font-size:20px;">ğŸ¢</span> : Tortues
          <span style="font-size:20px;">ğŸ¶</span> : Domestiques
          <span style="font-size:20px;">ğŸ¸</span> : Amphibiens
          <span style="font-size:20px;">ğŸ¦</span> : Reptiles
          <span style="font-size:20px;">â–²</span> : Autre
        `;
      } else if (csvUrl === csvURL2) {
        legend.style.display = 'inline';
        legendList.innerHTML = `
          <span style="font-size:20px;">ğŸ“</span> : MÃ©diation
          <span style="font-size:20px;">ğŸš‘</span> : Rapatrieur
          <span style="font-size:20px;">ğŸ©º</span> : Rapatrieur/MÃ©diation/Soigneur
          <span style="font-size:20px;">â–²</span> : Autre
        `;
      } else if (csvUrl === csvURL3) {
        legend.style.display = 'inline';
        legendList.innerHTML = `
          <span style="font-size:20px;">ğŸ’‰</span> : Euthanasie
          <span style="font-size:20px;">ğŸ©º</span> : Diagnostique
          <span style="font-size:20px;">ğŸ¼</span> : Nursing
          <span style="font-size:20px;">ğŸ› ï¸</span> : OpÃ©ration
          <span style="font-size:20px;">ğŸ“¦</span> : Point Relais
          <span style="font-size:20px;">ğŸ©¹</span> : Premiers soins
          <span style="font-size:20px;">ğŸ©»</span> : Radiographie
          <span style="font-size:20px;">ğŸ¦¤</span> : GoÃ©land
          <span style="font-size:20px;">ğŸ¦Š</span> : MammifÃ¨res
          <span style="font-size:20px;">ğŸ¦†</span> : Oiseaux
          <span style="font-size:20px;">ğŸ¦”</span> : Petits mammifÃ¨res
          <span style="font-size:20px;">ğŸ•Šï¸</span> : Pigeons Tourterelles
          <span style="font-size:20px;">ğŸ¦…</span> : Rapaces
          <span style="font-size:20px;">ğŸ¦</span> : Reptiles
          <span style="font-size:20px;">ğŸ¢</span> : Tortues
          <span style="font-size:20px;">ğŸ¦‡</span> : ChiroptÃ¨res
          <span style="font-size:20px;">ğŸš«ğŸ¦¤</span> : Pas goÃ©land
        `;
      } else {
        legend.style.display = 'none';
      }
    }

    async function updateData(csvUrl) {
      updateLegend(csvUrl);

      const minColumns = (csvUrl === csvURL1) ? 14 : 5;
      const geocoder = new google.maps.Geocoder();
      // On rÃ©initialise le debug HTML
      let debugInfoHTML = "";
      const markerPositions = new Map();
      // RÃ©initialisation des marqueurs et tableau debug
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      
      try {
        const response = await fetch(csvUrl);
        const csv = await response.text();

        Papa.parse(csv, {
          complete: async function(results) {
            console.log("Parsed CSV:", results.data);
            let markerCount = 0;
            for (let i = 1; i < results.data.length; i++) {
              const row = results.data[i];
              if (row.length >= minColumns) {
                let { name, repondu, Numero, cityName, espece, address, status, seil, Esp, info, marqueur, Emoj, Emoj2, poste, jourdispo } = extractData(row, csvUrl);
                const currentDay = new Date().toLocaleString('fr-FR', { weekday: 'long' });
                
                if (csvUrl === csvURL2) {
                  let availableDays = jourdispo;
                  if (availableDays) {
                    let daysArray = availableDays.split(',').map(day => day.trim().toLowerCase());
                    if (daysArray.includes(currentDay.toLowerCase())) {
                      status = "Disponible";
                    }
                  }
                }
                
                if ((csvUrl === csvURL2 && urgentMode) || status === "En cours" || status === "Disponible") {
                  let markerColor;
                  let icon;

                  if (csvUrl === csvURL1) {
                    markerColor = getColorFromNumero(Numero);
                  } else if (csvUrl === csvURL2) {
                    markerColor = getColorFromNumero(marqueur);
                  } else if (csvUrl === csvURL3) {
                    markerColor = getColorFromNumero(marqueur);
                  }

                  try {
                    if (!address || address.trim() === "") {
                      continue;
                    }
                    const location = await geocodeWithCache(geocoder, address);
                    let finalPosition = new google.maps.LatLng(location.lat, location.lng);
                    let positionKey = finalPosition.lat() + "," + finalPosition.lng();
                    let positionsForLocation;
                     if (markerPositions.has(positionKey)) {
    positionsForLocation = markerPositions.get(positionKey);
    positionsForLocation.count++;
                      } else {
    positionsForLocation = { count: 0, circlePoints: [] };
    markerPositions.set(positionKey, positionsForLocation);
    const RADIUS = 2000;
    const MAX_POINTS = 15;
    positionsForLocation.circlePoints = calculateCirclePoints(finalPosition, MAX_POINTS, RADIUS);
}
finalPosition = positionsForLocation.circlePoints[positionsForLocation.count % positionsForLocation.circlePoints.length];

                    if (csvUrl === csvURL1) {
                      const lowerEsp = Esp.toLowerCase();
                      if(lowerEsp.includes("oiseau")) {
                        icon = { url: createOisSVG(markerColor) };
                      } else if(lowerEsp.includes("mammifÃ¨re") || lowerEsp.includes("mammifere")) {
                        icon = { url: createMammSVG(markerColor) };
                      } else if(lowerEsp.includes("chiroptÃ¨re") || lowerEsp.includes("chiropter")) {
                        icon = { url: createChiroSVG(markerColor) };
                      } else if(lowerEsp.includes("serpent")) {
                        icon = { url: createserpSVG(markerColor) };
                      } else if(lowerEsp.includes("tortue")) {
                        icon = { url: createtortSVG(markerColor) };
                      } else if(lowerEsp.includes("domestique")) {
                        icon = { url: createDomSVG(markerColor) };
                      } else if(lowerEsp.includes("amphibien")) {
                        icon = { url: createamphiSVG(markerColor) };
                      } else if(lowerEsp.includes("reptile")) {
                        icon = { url: createreptSVG(markerColor) };
                      } else {
                        icon = { url: createTriangleSVG(markerColor) };
                      }
                      icon.optimized = false;
                    } else if (csvUrl === csvURL2) {
  const lowerMarqueur = marqueur.toLowerCase();
  if (lowerMarqueur.includes("soigneur")) {
    // PrioritÃ© : soigneur => icÃ´ne cross
    icon = { url: createCrossSVG(markerColor) };
  } else if (lowerMarqueur.includes("rapatrieur")) {
    // rapatrieur (mÃªme s'il y a aussi mÃ©diation) => icÃ´ne ambulance
    icon = { url: createAmbulanceSVG(markerColor) };
  } else if (lowerMarqueur.includes("mÃ©diation")) {
    // uniquement mÃ©diation => icÃ´ne tÃ©lÃ©phone
    icon = { url: createPhoneSVG(markerColor) };
  } else {
    icon = { url: createTriangleSVG(markerColor) };
  }
  icon.optimized = false;
} else {
                      if (address === cityName) {
                        icon = {
                          path: google.maps.SymbolPath.CIRCLE,
                          fillColor: markerColor,
                          fillOpacity: 0.8,
                          strokeColor: 'black',
                          strokeWeight: 2,
                          scale: 12,
                        };
                      } else {
                        icon = {
                          url: createTriangleSVG(markerColor),
                          scaledSize: new google.maps.Size(40, 40),
                        };
                      }
                    }
                    
                    
                    // CrÃ©ation du marqueur
                    const marker = new google.maps.Marker({
                      position: finalPosition,
                      map: map,
                      title: `${name} ${espece} ${Numero} \n${jourdispo}\n${info} ${Emoj} ${Emoj2}`,
                      icon: icon
                    });
                    
                    // Ajout des donnÃ©es personnalisÃ©es pour la recherche
                    marker.customData = {
                      cityName: cityName.toLowerCase(),
                      name: name.toLowerCase(),
                      espece: espece.toLowerCase()
                    };
                    // On attribue Ã©galement un index pour relier au debug
                    marker.customIndex = markerCount;
                    
                    marker.addListener("click", () => {
                      infoWindow.setContent(`<div style="font-size:20px; font-weight:bold; color:#333;">${name} (${espece} ${Numero}<br>${jourdispo}<br>${info}<br>${Emoj} ${Emoj2})</div>`);
                      infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                    
                    // PrÃ©paration du texte de debug pour ce marqueur
                    let debugLine = "";
                    if (csvUrl === csvURL1) {
                      debugLine = `${repondu} ---> ${espece} | Conseil : ${name} | NumÃ©ro : ${Numero} | lieu dÃ©couverte : ${cityName} | adresse : ${address} | appel : ${seil}`;
                    } else if (csvUrl === csvURL2) {
                      debugLine = `${name} --- ${cityName} NUMERO ${Numero} ${poste} ${espece}`;
                    } else {
                      debugLine = `${name} --- ${espece} --- ${cityName} NUMERO ${Numero} \nHoraires : ${jourdispo} \n| ${info} ${Emoj} | ${Emoj2}`;
                    }
                    // Ajout d'une ligne debug avec un id unique
                    debugInfoHTML += `<div id="debug-line-${markerCount}" data-index="${markerCount}">${debugLine}</div>\n`;
                    markerCount++;
                  } catch (geocodeStatus) {
                    console.error(`Erreur de gÃ©ocodage pour ${address}: ${geocodeStatus}`);
                  }
                }
              }
            }
            document.getElementById('debug-info').innerHTML = debugInfoHTML;
          }
        });
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('error-message').textContent = "Erreur lors de la rÃ©cupÃ©ration des donnÃ©es. VÃ©rifiez la console.";
      }
    }

    // Fonction de recherche qui permet de cycler sur les marqueurs correspondant
    function searchMarkers() {
      const searchTerm = document.getElementById("search-input").value.trim().toLowerCase();
      if (!searchTerm) return;
      
      // Si le terme de recherche a changÃ©, on reconstruit le tableau de rÃ©sultats
      if (searchTerm !== lastSearchTerm) {
        searchResults = markers.filter(marker => {
          return marker.customData.cityName.includes(searchTerm) ||
                 marker.customData.name.includes(searchTerm) ||
                 marker.customData.espece.includes(searchTerm);
        });
        currentSearchIndex = 0;
        lastSearchTerm = searchTerm;
      }
      
      if (searchResults.length === 0) {
        alert("Aucun marqueur correspondant n'a Ã©tÃ© trouvÃ©.");
        return;
      }
      
      // SÃ©lection du marqueur suivant dans le tableau de rÃ©sultats
      const markerFound = searchResults[currentSearchIndex % searchResults.length];
      currentSearchIndex++;
      
      map.setCenter(markerFound.getPosition());
      map.setZoom(10);
      infoWindow.setContent(markerFound.getTitle());
      infoWindow.open(map, markerFound);
      
      // Mise en surbrillance dans le debug-info
      // D'abord, on retire la classe 'highlight' de toutes les lignes
      const debugLines = document.querySelectorAll("#debug-info > div");
      debugLines.forEach(line => line.classList.remove("highlight"));
      // On ajoute la classe 'highlight' Ã  la ligne correspondant au marqueur trouvÃ©
      const debugLine = document.getElementById(`debug-line-${markerFound.customIndex}`);
      if (debugLine) {
        debugLine.classList.add("highlight");
        
      }
    }

    function getColorFromNumero(numero) {
      const hash = Array.from(numero).reduce((acc, char) => acc + char.charCodeAt(0), 0);
      const r = (hash * 115) % 256;
      const g = (hash * 1114) % 256;
      const b = (hash * 1111) % 256;
      return `rgb(${r},${g},${b})`;
    }
  </script>
</body>
</html>
